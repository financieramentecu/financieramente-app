name: "Visual Testing with Chromatic"

on:
    push:
        branches: [develop]
    pull_request:
        branches: [develop]

jobs:
    chromatic-deployment:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run unit tests
              run: npm run test:unit:coverage

            - name: Build Storybook
              run: npm run build-storybook

            - name: Publish to Chromatic
              id: chromatic
              uses: chromaui/action@latest
              with:
                  projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
                  buildScriptName: build-storybook
                  exitZeroOnChanges: false
                  exitOnceUploaded: false
                  onlyChanged: true
                  autoAcceptChanges: ${{ github.ref == 'refs/heads/develop' }}
                  ignoreLastBuildOnBranch: develop

            - name: Comment PR with Chromatic results
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const storybookUrl = '${{ steps.chromatic.outputs.storybookUrl }}'
                      const buildUrl = '${{ steps.chromatic.outputs.buildUrl }}'
                      const changeCount = '${{ steps.chromatic.outputs.changeCount }}'

                      const body = `## üé® Visual Testing Results

                      ${changeCount > 0 ? '‚ö†Ô∏è **Visual changes detected!**' : '‚úÖ **No visual changes**'}

                      - üìö [View Storybook](${storybookUrl})
                      - üîç [Review Changes](${buildUrl})
                      - üìä Changes: ${changeCount}

                      ${changeCount > 0 ? '**Action required**: Please review and approve changes in Chromatic before merging.' : ''}`

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: body
                      })

            - name: Visual testing status check
              if: steps.chromatic.outputs.changeCount > 0
              run: |
                  echo "‚ùå Visual changes detected and not approved"
                  echo "Please review changes at: ${{ steps.chromatic.outputs.buildUrl }}"
                  exit 1
