name: "Visual Testing with Chromatic"

on:
    pull_request:
        branches: [develop]

jobs:
    chromatic-deployment:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Check for relevant changes
              id: changes
              uses: dorny/paths-filter@v3
              with:
                  filters: |
                      storybook:
                          - 'src/stories/**'
                          - 'src/components/**/*.tsx'
                          - 'src/components/**/*.ts'
                          - 'src/app/**/*.tsx'
                          - 'src/app/**/*.css'
                          - '.storybook/**'
                          - 'tailwind.config.ts'
                          - 'postcss.config.mjs'
                          - 'src/lib/utils.ts'
                          - 'package.json'
                          - 'package-lock.json'

            - name: Setup Node.js
              if: steps.changes.outputs.storybook == 'true'
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              if: steps.changes.outputs.storybook == 'true'
              run: npm ci

            - name: Run unit tests
              if: steps.changes.outputs.storybook == 'true'
              run: npm run test:unit:coverage

            - name: Build Storybook
              if: steps.changes.outputs.storybook == 'true'
              run: npm run build-storybook

            - name: Publish to Chromatic
              if: steps.changes.outputs.storybook == 'true'
              id: chromatic
              uses: chromaui/action@latest
              with:
                  projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
                  buildScriptName: build-storybook
                  exitZeroOnChanges: false
                  exitOnceUploaded: false
                  onlyChanged: true
                  autoAcceptChanges: ${{ github.ref == 'refs/heads/develop' }}
                  ignoreLastBuildOnBranch: develop

            - name: Comment PR with Chromatic results
              if: steps.changes.outputs.storybook == 'true' && github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const storybookUrl = '${{ steps.chromatic.outputs.storybookUrl }}'
                      const buildUrl = '${{ steps.chromatic.outputs.buildUrl }}'
                      const changeCount = '${{ steps.chromatic.outputs.changeCount }}'

                      const isDevelopBranch = context.ref === 'refs/heads/develop'
                      const body = `## ğŸ¨ Visual Testing Results

                      ${changeCount > 0 
                        ? (isDevelopBranch 
                            ? 'âœ… **Visual changes detected and auto-accepted!**' 
                            : 'âš ï¸ **Visual changes detected!**')
                        : 'âœ… **No visual changes**'}

                      - ğŸ“š [View Storybook](${storybookUrl})
                      - ğŸ” [Review Changes](${buildUrl})
                      - ğŸ“Š Changes: ${changeCount}

                      ${changeCount > 0 && !isDevelopBranch 
                        ? '**Action required**: Please review and approve changes in Chromatic before merging.' 
                        : changeCount > 0 && isDevelopBranch 
                        ? '**Auto-accepted**: Changes were automatically approved on develop branch.' 
                        : ''}`

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: body
                      })

            - name: Visual testing status check
              if: steps.changes.outputs.storybook == 'true' && steps.chromatic.outputs.changeCount > 0 && github.ref != 'refs/heads/develop'
              run: |
                  echo "âŒ Visual changes detected and not approved"
                  echo "Please review changes at: ${{ steps.chromatic.outputs.buildUrl }}"
                  exit 1

            - name: Visual testing success (auto-accepted)
              if: steps.changes.outputs.storybook == 'true' && steps.chromatic.outputs.changeCount > 0 && github.ref == 'refs/heads/develop'
              run: |
                  echo "âœ… Visual changes detected and auto-accepted on develop branch"
                  echo "ğŸ“Š Changes: ${{ steps.chromatic.outputs.changeCount }}"
                  echo "ğŸ”— Build details: ${{ steps.chromatic.outputs.buildUrl }}"

            - name: No visual changes to test
              if: steps.changes.outputs.storybook != 'true'
              run: |
                  echo "âœ… No changes detected in visual components"
                  echo "ğŸ“ Skipped files: Stories, Components, Styles, Tailwind config"
                  echo "ğŸ’° Chromatic build skipped to save resources"
